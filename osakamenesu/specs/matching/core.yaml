info:
  id: matching.core
  title: Matching domain core contract
  summary: Guest matching request/response and scoring breakdown.

contexts:
  MatchingRequest:
    description: Guest input for matching search.
    fields:
      area: { type: string, required: true }
      date: { type: string, format: date, required: true }
      time_from: { type: string, required: false }
      time_to: { type: string, required: false }
      budget_level: { type: string, enum: [low, mid, high], required: false }
      mood_pref: { type: object, additionalProperties: number, required: false }
      talk_pref: { type: object, additionalProperties: number, required: false }
      style_pref: { type: object, additionalProperties: number, required: false }
      look_pref: { type: object, additionalProperties: number, required: false }
      free_text: { type: string, required: false }
      guest_token: { type: string, required: false }
  SimilarQuery:
    description: Query params for similar therapist recommendations.
    fields:
      staff_id: { type: string, required: true }
      limit: { type: integer, required: false, default: 8, minimum: 1, maximum: 20 }
      shop_id: { type: string, required: false }
      exclude_unavailable: { type: boolean, required: false, default: true }
      min_score: { type: number, required: false, default: 0.4 }

entities:
  MatchingBreakdown:
    fields:
      core: number
      priceFit: number
      moodFit: number
      talkFit: number
      styleFit: number
      lookFit: number
      availability: number
  MatchingCandidate:
    fields:
      therapist_id: string
      therapist_name: string
      shop_id: string
      shop_name: string
      score: number
      breakdown: MatchingBreakdown
      summary: { type: string, required: false }
      slots:
        type: array
        items:
          type: object
          properties:
            start_at: string
            end_at: string
      mood_tag: string
      style_tag: string
      look_type: string
      talk_level: string
      contact_style: string
      hobby_tags:
        type: array
        items: string
  MatchingResponse:
    fields:
      top_matches:
        type: array
        items: MatchingCandidate
      other_candidates:
        type: array
        items: MatchingCandidate
  SimilarTherapistItem:
    fields:
      id: string
      name: string
      age: { type: integer, required: false, nullable: true }
      price_rank: { type: integer, required: false, nullable: true }
      mood_tag: { type: string, required: false, nullable: true }
      style_tag: { type: string, required: false, nullable: true }
      look_type: { type: string, required: false, nullable: true }
      contact_style: { type: string, required: false, nullable: true }
      hobby_tags:
        type: array
        items: string
      photo_url: { type: string, required: false, nullable: true }
      is_available_now: boolean
      score: number
      photo_similarity: number
      tag_similarity: number
  SimilarResponse:
    fields:
      base_staff_id: string
      items:
        type: array
        items: SimilarTherapistItem

endpoints:
  - id: matching.search
    method: GET
    path: /api/guest/matching/search
    request: null
    query: MatchingSearchQuery
    response: MatchingSearchResponse
    notes:
      - Scoring v2 (sort=recommended): score = 0.60 * photo_score + 0.25 * tag_score + 0.10 * price_score + 0.05 * age_score (clipped 0..1).
      - photo_similarity is 0.5 when base_staff_id is missing; otherwise computed via embeddings (TODO).
      - Non-recommended sorts keep existing ordering and may ignore score.
  - id: matching.similar
    method: GET
    path: /api/guest/matching/similar
    query: SimilarQuery
    response: SimilarResponse
    notes:
      - Final score = 0.6 * photo_similarity + 0.2 * tag_similarity + 0.1 * price_score + 0.1 * age_score (0..1 clipped).
      - tag_similarity weights: mood 0.30, style 0.25, look 0.25, contact 0.10, hobby_tags 0.10 (Jaccard, empty => 0).
      - price_score: diff 0 => 1.0, diff 1 => 0.6, diff 2 => 0.2, diff >=3 => 0.0; missing => 0.5.
      - age_score: 1 - |age diff| / 15 (missing => 0.5).
      - photo_similarity is a placeholder for embeddings; v1 mirrors tag_similarity.
      - Candidates with score < min_score or base_staff_id are excluded; tie-break prefers same shop then id asc.
