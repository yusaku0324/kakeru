info:
  id: matching.search
  title: Guest matching search v2
  summary: Search therapists for guests with photo/tag/price/age scoring.

contexts:
  MatchingSearchQuery:
    fields:
      shop_id: { type: string, required: false }
      date: { type: string, format: date, required: false }
      start_time: { type: string, required: false }
      duration_minutes: { type: integer, required: false }
      mood_tags: { type: array, items: string, required: false }
      style_tags: { type: array, items: string, required: false }
      look_types: { type: array, items: string, required: false }
      contact_styles: { type: array, items: string, required: false }
      hobby_tags: { type: array, items: string, required: false }
      price_rank_min: { type: integer, required: false }
      price_rank_max: { type: integer, required: false }
      age_min: { type: integer, required: false }
      age_max: { type: integer, required: false }
      base_staff_id: { type: string, required: false }
      sort: { type: string, required: false, default: recommended }
      limit: { type: integer, required: false, default: 30, maximum: 100, minimum: 1 }
      offset: { type: integer, required: false, default: 0, minimum: 0 }
      phase:
        type: string
        required: false
        enum: [explore, narrow, book]
        description: >
          concierge / search flow のフェーズ。
          - explore: 好み探索フェーズ。availability は計算しない/score に効かせない。
          - narrow: 好みは見えつつあり、ざっくり時期も決まりつつあるフェーズ。
            availability はブーストのみ（is_available==true の候補に加点する）が、フィルタはしない。
          - book: 具体的な日時で予約したいフェーズ。
            availability でフィルタし、予約可能な候補のみに絞り込む。
      step_index:
        type: integer
        required: false
        minimum: 1
        description: >
          コンシェルジュ/マッチングフローにおけるこの検索のステップ番号。
          1 が最初の候補提示/検索、2 が2回目…という形でクライアント側（concierge）がインクリメントして送信する。通常検索フォームなど、ステップ概念がない場合は省略可。
      entry_source:
        type: string
        required: false
        description: >
          この matching/search がどの入口から発火したかを表す識別子。
          例: "search_form", "concierge", "therapist_detail", "other" など。
          v1 ではバリデーションは緩くし、未知の文字列はそのまま保存する。

entities:
  MatchingSearchItem:
    fields:
      id: string
      name: string
      age: { type: integer, required: false, nullable: true }
      price_rank: { type: integer, required: false, nullable: true }
      mood_tag: { type: string, required: false, nullable: true }
      style_tag: { type: string, required: false, nullable: true }
      look_type: { type: string, required: false, nullable: true }
      contact_style: { type: string, required: false, nullable: true }
      hobby_tags:
        type: array
        items: string
      photo_url: { type: string, required: false, nullable: true }
      is_available: { type: boolean, required: false, nullable: true }
      score: number
      photo_similarity: number
      breakdown:
        type: object
        properties:
          base_staff_similarity: number
          tag_similarity: number
          price_match: number
          age_match: number
          photo_similarity: number
          availability_boost: number
  MatchingSearchResponse:
    fields:
      items:
        type: array
        items: MatchingSearchItem
      total: integer

endpoints:
  - id: matching.search
    method: GET
    path: /api/guest/matching/search
    query: MatchingSearchQuery
    response: MatchingSearchResponse
    notes:
      - sort=recommended uses new scoring with breakdown:
        base_staff_similarity, tag_similarity, price_match, age_match, photo_similarity, availability_boost
        (all 0..1).
      - score = clamp(
          0.35*base_staff_similarity +
          0.25*tag_similarity +
          0.15*price_match +
          0.10*age_match +
          0.10*photo_similarity +
          0.05*availability_boost,
          0..1
        ).
      - availability_boost:
          - phase=explore: availability は計算せず、availability_boost は常に 0 とする。
          - phase=narrow: is_available を計算し、is_available==true の場合のみ availability_boost>0
            (v1 実装では 1.0)。false/null の場合は 0.0。フィルタは行わず加点のみ。
          - phase=book: is_available を計算し、is_available==true の候補だけを items に含める。
            つまり予約可能な候補のみに絞り込む。availability_boost は true の候補に対してのみ
            >0 (v1 実装では 1.0) としてよい。
      - phase が未指定の場合のデフォルト:
          - 通常の検索フォームから date/start_time/duration_minutes が指定されている場合は、
            phase=book 相当として扱い、予約可能な候補のみを返すことを想定している。
          - date/start_time/duration_minutes も指定されていない場合は、phase=explore 相当として扱い、
            availability はスコアにもフィルタにも用いない前提とする。
          - concierge フローからは必ず phase を明示的に送ることを推奨する。
      - tag weights: mood 0.25, style 0.20, look 0.30, contact 0.10, hobby_tags 0.15
        (Jaccard; empty/empty => 0.5, one empty => 0.0)。
      - price_match: ideal=(min+max)/2; diff 0=>1.0, 1=>0.6, 2=>0.2, >=3=>0.0; missing =>0.5。
      - age_match: ideal=(min+max)/2; 1 - |diff|/15; missing =>0.5。
      - Candidates filtered by existing availability/profile visibility; recommended のみこのスコアでソート。
        他の sort は従来順序。

ui_display:
  next_available_slot_label:
    description: >
      検索結果カード（TherapistCard）に表示する「次回予約可能スロット」ラベルの表示仕様。
      formatNextSlotLabel 関数で実装。
    priority:
      - order: 1
        condition: next_available_slot.start_at が存在 & 本日
        display: "本日 {時}時から" または "本日 {時}時{分}分から"
        example: "本日 17時から"
      - order: 2
        condition: next_available_slot.start_at が存在 & 別日
        display: "{月}月{日}日 {時}時から" または "{月}月{日}日 {時}時{分}分から"
        example: "12月9日 14時から"
      - order: 3
        condition: today_available === true & next_available_slot なし
        display: "本日空きあり"
        example: "本日空きあり"
      - order: 4
        condition: それ以外
        display: null（表示なし）
    notes:
      - 具体的なスロット情報（next_available_slot）がある場合は、それを優先して表示する。
      - today_available フラグは、スロット情報がない場合のフォールバックとしてのみ使用する。
      - 分が0の場合は「17時から」、それ以外は「17時30分から」のように表示する。
