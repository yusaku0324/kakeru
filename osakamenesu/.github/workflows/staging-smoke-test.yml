name: Staging Smoke Test

on:
  # Run after deploy to staging (manual trigger or after fly deploy)
  workflow_dispatch:
    inputs:
      api_url:
        description: 'Staging API URL'
        required: false
        default: 'https://osakamenesu-api.fly.dev'

  # Can also be triggered by other workflows
  workflow_call:
    inputs:
      api_url:
        type: string
        required: false
        default: 'https://osakamenesu-api.fly.dev'

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install httpx
        run: pip install httpx

      - name: Run smoke tests
        env:
          API_URL: ${{ inputs.api_url || 'https://osakamenesu-api.fly.dev' }}
        run: |
          python -c "
          import httpx
          import sys
          import os

          API_URL = os.environ['API_URL']
          print(f'Testing API at: {API_URL}')

          errors = []
          passed = []

          def test_endpoint(name, method, path, params=None, expected_status=200):
              url = f'{API_URL}{path}'
              try:
                  if method == 'GET':
                      response = httpx.get(url, params=params, timeout=30)
                  elif method == 'POST':
                      response = httpx.post(url, json=params, timeout=30)

                  if response.status_code == expected_status:
                      passed.append(f'✅ {name}: {response.status_code}')
                      return True
                  else:
                      errors.append(f'❌ {name}: expected {expected_status}, got {response.status_code}')
                      return False
              except Exception as e:
                  errors.append(f'❌ {name}: {str(e)}')
                  return False

          # Health check
          test_endpoint('Health check', 'GET', '/health')

          # API docs
          test_endpoint('OpenAPI docs', 'GET', '/docs', expected_status=200)

          # Guest matching search (main endpoint that had issues)
          test_endpoint(
              'Guest matching search',
              'GET',
              '/api/guest/matching/search',
              params={'area': '天王寺', 'date': '2025-12-10'},
              expected_status=200
          )

          # Shop search
          test_endpoint(
              'Shop search',
              'GET',
              '/api/site/shops/search',
              expected_status=200
          )

          # Print results
          print('\\n=== Smoke Test Results ===')
          for p in passed:
              print(p)
          for e in errors:
              print(e)

          print(f'\\nPassed: {len(passed)}, Failed: {len(errors)}')

          if errors:
              sys.exit(1)
          "

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Staging smoke tests failed! Check the API deployment."
