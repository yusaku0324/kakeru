name: Production Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deployment only)'
        required: false
        default: false
        type: boolean

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          cd services/api
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Web Tests
        run: |
          cd services/web
          pnpm test

      - name: Run API Tests
        run: |
          cd services/api
          pytest

      - name: Run API Integration Tests
        run: |
          cd services/api
          pytest tests/integration/ -v
        env:
          DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/test_db"
          REDIS_URL: "redis://localhost:6379"
        services:
          postgres:
            image: postgres:15
            env:
              POSTGRES_PASSWORD: postgres
              POSTGRES_DB: test_db
            options: >-
              --health-cmd pg_isready
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
            ports:
              - 5432:5432
          redis:
            image: redis:7
            options: >-
              --health-cmd "redis-cli ping"
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
            ports:
              - 6379:6379

  deploy-api:
    name: Deploy API to Production
    needs: [test]
    if: ${{ always() && (needs.test.result == 'success' || inputs.skip_tests) }}
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://api.osakamenesu.com
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io Production
        run: |
          cd services/api
          flyctl deploy --remote-only

      - name: Health Check
        run: |
          sleep 30
          curl -f https://api.osakamenesu.com/health || exit 1

      - name: Verify API Version
        run: |
          API_VERSION=$(curl -s https://api.osakamenesu.com/health | jq -r '.version')
          echo "Deployed API version: $API_VERSION"

  deploy-web:
    name: Deploy Web to Production
    needs: [test]
    if: ${{ always() && (needs.test.result == 'success' || inputs.skip_tests) }}
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://osakamenesu.com
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel Production
        id: deploy
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ env.VERCEL_ORG_ID }}
          vercel-project-id: ${{ env.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./services/web
          scope: ${{ secrets.VERCEL_SCOPE }}

  post-deployment:
    name: Post Deployment Tasks
    needs: [deploy-api, deploy-web]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Database Migrations
        run: |
          echo "Database migrations are handled automatically by the API on startup"

      - name: Warm Up Cache
        run: |
          # Warm up critical endpoints
          curl -s https://api.osakamenesu.com/api/v1/shops?limit=10
          curl -s https://api.osakamenesu.com/api/v1/therapists?limit=10
          echo "Cache warmed up"

      - name: Notify Sentry of Deployment
        run: |
          curl https://sentry.io/api/0/organizations/${{ secrets.SENTRY_ORG }}/releases/ \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ github.sha }}",
              "ref": "${{ github.ref }}",
              "environment": "production",
              "projects": ["osakamenesu-api", "osakamenesu-web"]
            }'

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = `v${new Date().toISOString().slice(0,10).replace(/-/g,'.')}-${context.sha.slice(0,7)}`;

            try {
              const release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: `Production Release ${tag}`,
                body: `## Production Deployment

                **Commit**: ${context.sha}
                **Deployed by**: @${context.actor}
                **API**: https://api.osakamenesu.com
                **Web**: https://osakamenesu.com

                ### Changes
                See [commit diff](https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${context.payload.before}...${context.sha})
                `,
                draft: false,
                prerelease: false
              });

              console.log(`Created release ${release.data.html_url}`);
            } catch (error) {
              console.error('Failed to create release:', error);
            }

  rollback:
    name: Rollback on Failure
    needs: [deploy-api, deploy-web, post-deployment]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Rollback API
        if: needs.deploy-api.result == 'failure'
        run: |
          flyctl releases list --app osakamenesu-api --json | \
            jq -r '.[1].id' | \
            xargs -I {} flyctl releases rollback {} --app osakamenesu-api
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Rollback Web
        if: needs.deploy-web.result == 'failure'
        run: |
          vercel rollback --scope ${{ secrets.VERCEL_SCOPE }} --yes
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Notify Team of Rollback
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Production deployment failed and rolled back`,
              body: `The production deployment for commit ${context.sha} failed and was automatically rolled back.

              **Failed Jobs**: ${Object.entries(needs).filter(([_, job]) => job.result === 'failure').map(([name]) => name).join(', ')}
              **Actor**: @${context.actor}

              Please investigate the failure in the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).`,
              labels: ['bug', 'deployment', 'urgent']
            });