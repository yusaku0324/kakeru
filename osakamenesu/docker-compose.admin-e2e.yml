services:
  db:
    image: postgres:15
    env_file:
      - .env.admin-e2e
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-app}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-app}
      POSTGRES_DB: app
      TZ: Asia/Tokyo
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER:-app}"]
      interval: 5s
      timeout: 5s
      retries: 12
    networks:
      - admin-e2e

  meili:
    image: getmeili/meilisearch:v1.7
    env_file:
      - .env.admin-e2e
    environment:
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY:-dev_meili_master_key}
      MEILI_ENV: development
    expose:
      - "7700"
    networks:
      - admin-e2e

  redis:
    image: redis:7-alpine
    env_file:
      - .env.admin-e2e
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    networks:
      - admin-e2e

  api:
    platform: ${COMPOSE_PLATFORM:-linux/amd64}
    image: ${ADMIN_API_IMAGE:-ghcr.io/yusaku0324/osakamenesu-api:latest}
    env_file:
      - .env.admin-e2e
    environment:
      DATABASE_URL: postgresql+asyncpg://app:app@db:5432/app
      MEILI_HOST: http://meili:7700
      RATE_LIMIT_REDIS_URL: redis://redis:6379/0
      API_HOST: 0.0.0.0
      API_ORIGIN: http://web:3000
      PORT: 8000
      TEST_AUTH_SECRET: ${TEST_AUTH_SECRET:-dev_test_auth}
      E2E_TEST_AUTH_SECRET: ${E2E_TEST_AUTH_SECRET:-dev_test_auth}
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY:-dev_meili_master_key}
      TZ: Asia/Tokyo
    depends_on:
      db:
        condition: service_healthy
      meili:
        condition: service_started
      redis:
        condition: service_started
    ports:
      - "8000:8000"
    command: ["bash", "start.sh"]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8000/healthz >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 60s
    networks:
      - admin-e2e

  web:
    platform: ${COMPOSE_PLATFORM:-linux/amd64}
    image: ${ADMIN_WEB_IMAGE:-ghcr.io/yusaku0324/osakamenesu-web:latest}
    env_file:
      - .env.admin-e2e
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_OSAKAMENESU_API_BASE: http://api:8000
      NEXT_PUBLIC_SITE_URL: http://web:3000
      ADMIN_API_KEY: ${ADMIN_API_KEY:-dev_admin_key}
      OSAKAMENESU_API_INTERNAL_BASE: http://api:8000
      ADMIN_BASIC_USER: ${ADMIN_BASIC_USER:-admin}
      ADMIN_BASIC_PASS: ${ADMIN_BASIC_PASS:-password}
      FAVORITES_API_MODE: real
      NEXT_PUBLIC_FAVORITES_API_MODE: real
      PORT: 3000
      HOSTNAME: 0.0.0.0
      MEILI_HOST: http://meili:7700
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY:-dev_meili_master_key}
      NEXT_PUBLIC_MEILI_HOST: http://meili:7700
      NEXT_PUBLIC_MEILI_API_KEY: ${MEILI_MASTER_KEY:-dev_meili_master_key}
      TZ: Asia/Tokyo
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3000/api/health >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 25
      start_period: 45s
    networks:
      admin-e2e:
        aliases:
          - web

  e2e:
    image: ${ADMIN_E2E_IMAGE:-ghcr.io/yusaku0324/osakamenesu-e2e-runner:latest}
    working_dir: /workspace/apps/web
    env_file:
      - .env.admin-e2e
    environment:
      NODE_ENV: production
      TEST_AUTH_SECRET: ${TEST_AUTH_SECRET:-dev_test_auth}
      E2E_TEST_AUTH_SECRET: ${E2E_TEST_AUTH_SECRET:-dev_test_auth}
      E2E_BASE_URL: http://web:3000
      ADMIN_WEB_HOST: web
      ADMIN_WEB_PORT: "3000"
      E2E_SEED_API_BASE: http://api:8000
      OSAKAMENESU_API_INTERNAL_BASE: http://api:8000
      API_INTERNAL_BASE: http://api:8000
      ADMIN_API_KEY: ${ADMIN_API_KEY:-dev_admin_key}
      ADMIN_BASIC_USER: ${ADMIN_BASIC_USER:-admin}
      ADMIN_BASIC_PASS: ${ADMIN_BASIC_PASS:-password}
      CI: "1"
      TZ: Asia/Tokyo
    volumes:
      - .:/workspace
      - admin-e2e-web-node-modules:/workspace/apps/web/node_modules
      - admin-e2e-web-pnpm-store:/workspace/apps/web/.pnpm-store
    depends_on:
      web:
        condition: service_healthy
    command: ["bash", "/workspace/scripts/run_admin_e2e.sh"]
    links:
      - web
    extra_hosts:
      - "web:host-gateway"
    networks:
      - admin-e2e

networks:
  admin-e2e:
    driver: bridge

volumes:
  admin-e2e-web-node-modules:
  admin-e2e-web-pnpm-store:
