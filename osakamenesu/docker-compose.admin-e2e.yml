services:
  db:
    image: postgres:15
    env_file:
      - .env.admin-e2e
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-app}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-app}
      POSTGRES_DB: ${POSTGRES_DB:-osaka_menesu}
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER:-app}"]
      interval: 5s
      timeout: 5s
      retries: 12

  meili:
    image: getmeili/meilisearch:v1.7
    env_file:
      - .env.admin-e2e
    environment:
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY:-dev_meili_master_key}
      MEILI_ENV: development
    expose:
      - "7700"

  redis:
    image: redis:7-alpine
    env_file:
      - .env.admin-e2e
    command: ["redis-server", "--save", "", "--appendonly", "no"]

  api:
    image: ${ADMIN_API_IMAGE:-osakamenesu-admin-api:latest}
    build:
      context: ./services/api
    env_file:
      - .env.admin-e2e
    environment:
      DATABASE_URL: postgresql+asyncpg://app:app@db:5432/osaka_menesu
      MEILI_HOST: http://meili:7700
      RATE_LIMIT_REDIS_URL: redis://redis:6379/0
      API_HOST: 0.0.0.0
      API_ORIGIN: http://web:3000
      PORT: 8000
      TEST_AUTH_SECRET: ${TEST_AUTH_SECRET:-dev_test_auth}
      E2E_TEST_AUTH_SECRET: ${E2E_TEST_AUTH_SECRET:-dev_test_auth}
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY:-dev_meili_master_key}
    depends_on:
      db:
        condition: service_healthy
      meili:
        condition: service_started
      redis:
        condition: service_started
    ports:
      - "8000:8000"
    command: ["bash", "start.sh"]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8000/healthz >/dev/null || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 40
      start_period: 120s

  web:
    image: ${ADMIN_WEB_IMAGE:-osakamenesu-admin-web:latest}
    build:
      context: ./apps/web
      args:
        NEXT_PUBLIC_OSAKAMENESU_API_BASE: http://api:8000
        NEXT_PUBLIC_SITE_URL: http://web:3000
        FAVORITES_API_MODE: real
        NEXT_PUBLIC_FAVORITES_API_MODE: real
    env_file:
      - .env.admin-e2e
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_OSAKAMENESU_API_BASE: http://api:8000
      NEXT_PUBLIC_SITE_URL: http://web:3000
      ADMIN_API_KEY: ${ADMIN_API_KEY:-dev_admin_key}
      OSAKAMENESU_API_INTERNAL_BASE: http://api:8000
      ADMIN_BASIC_USER: ${ADMIN_BASIC_USER:-admin}
      ADMIN_BASIC_PASS: ${ADMIN_BASIC_PASS:-password}
      FAVORITES_API_MODE: real
      NEXT_PUBLIC_FAVORITES_API_MODE: real
      PORT: 3000
      HOSTNAME: 0.0.0.0
      MEILI_HOST: http://meili:7700
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY:-dev_meili_master_key}
      NEXT_PUBLIC_MEILI_HOST: http://meili:7700
      NEXT_PUBLIC_MEILI_API_KEY: ${MEILI_MASTER_KEY:-dev_meili_master_key}
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_healthy
    command: ["node", "server.js"]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/health >/dev/null || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 40
      start_period: 90s

  e2e:
    image: ${ADMIN_E2E_IMAGE:-osakamenesu-admin-e2e-runner:latest}
    build:
      context: .
      dockerfile: docker/e2e-runner.Dockerfile
    working_dir: /workspace/apps/web
    env_file:
      - .env.admin-e2e
    environment:
      NODE_ENV: production
      OSAKAMENESU_API_INTERNAL_BASE: http://api:8000
      NEXT_PUBLIC_OSAKAMENESU_API_BASE: http://api:8000
      NEXT_PUBLIC_SITE_URL: http://web:3000
      FAVORITES_API_MODE: real
      NEXT_PUBLIC_FAVORITES_API_MODE: real
      TEST_AUTH_SECRET: ${TEST_AUTH_SECRET:-dev_test_auth}
      E2E_TEST_AUTH_SECRET: ${E2E_TEST_AUTH_SECRET:-dev_test_auth}
      ADMIN_API_KEY: ${ADMIN_API_KEY:-dev_admin_key}
      E2E_SEED_API_BASE: http://api:8000
      E2E_API_BASE: http://api:8000
      E2E_BASE_URL: http://web:3000
      ADMIN_BASIC_USER: ${ADMIN_BASIC_USER:-admin}
      ADMIN_BASIC_PASS: ${ADMIN_BASIC_PASS:-password}
      CI: "1"
    volumes:
      - .:/workspace
    depends_on:
      web:
        condition: service_healthy
    command: >
      bash -lc "
        cd /workspace &&
        corepack enable &&
        pnpm install &&
        cd apps/web &&
        for i in {1..60}; do 
          if getent hosts api >/dev/null 2>&1 && getent hosts web >/dev/null 2>&1; then 
            if curl -fsS http://api:8000/healthz >/dev/null && curl -fsS http://web:3000 >/dev/null; then 
              break; 
            fi; 
          fi; 
          sleep 2; 
        done && 
        export PLAYWRIGHT_WORKERS="$${PLAYWRIGHT_WORKERS:-4}" && \
        SHARD_ARGS="" && \
        if [ -n "$${PLAYWRIGHT_TOTAL_SHARDS:-}" ] && [ -n "$${PLAYWRIGHT_SHARD_INDEX:-}" ]; then \
          SHARD_ARGS=" --shard=$${PLAYWRIGHT_SHARD_INDEX}/$${PLAYWRIGHT_TOTAL_SHARDS}"; \
        fi && \
        pnpm test:e2e -- --workers="$${PLAYWRIGHT_WORKERS}"$${SHARD_ARGS}; \
        TEST_EXIT=$$?; \
        pnpm exec playwright merge-reports --report-dir=playwright-report ./blob-report >/dev/null 2>&1 || true; \
        exit $$TEST_EXIT
      "
