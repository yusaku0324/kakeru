# 店舗向けダッシュボード公開に向けた対応項目

## 現状の把握
- `/dashboard` 配下の UI、Magic Link 認証、Cloud Run へのデプロイまでは整備済み。
- ログインリンクは `scripts/dev_magic_link.sh` など開発者向けツールで発行しており、店舗側には共有されていない。
- メール送信は Cloud Run ログに `MAGIC_LINK_DEBUG` を書き出すデバッグ用途のみで、本番ドメインや DKIM 設定が未整備。
- 店舗プロフィールとログインユーザーの関連付けは手動前提（Seed 実行時に作成したダミーアカウントのみ）。
- 運営側が更新内容を把握する仕組み（履歴、承認フロー、サポート窓口）がない。

## 必須タスク
1. **アカウント発行・招待フロー**
   - 店舗メールアドレスを登録し、ワンクリックでマジックリンクを送信する管理画面（もしくは CLI）を用意。
   - 招待済みアドレスと店舗プロフィール ID を紐付けるテーブルを整備。  
     例: `dashboard_users (id, profile_id, email, invited_by, invited_at, last_login_at)`
   - 招待キャンセルや再送を行えるようにする。

2. **メール配送基盤**
   - 送信元ドメイン（例: `notify.osakamenesu.jp`）を決定し、SPF/DKIM/DMARC を設定。
   - 本番で利用するメールサービス（SendGrid / AWS SES / Resend など）を選定し、API キー管理とレート制限を定義。
   - Magic Link、通知メール、パスワードレス認証に使うテンプレート文面（日本語）を整備。

3. **権限と API サイドの整備**
   - `dashboard_users` と `profiles` を参照する認可チェックを `/api/dashboard/*` に実装（現在は Seed ユーザー前提で簡易チェック）。
   - 店舗側が編集可能なフィールドをスキーマで定義し、不可視フィールドへのアクセスを禁止。
   - 操作ログ (`admin_change_logs` など) に店舗ユーザーの ID を記録し、運営が監査できるようにする。

4. **UI/UX の安全策**
   - 入力バリデーション、下書き保存、公開前プレビューを実装し、誤操作時のアラートを整備。
   - 重要フィールド変更時に運営へ Slack/メール通知する仕組みを追加。
   - 利用ガイド・FAQ を `/dashboard/help` に用意し、問い合わせ窓口を案内。

5. **サポートとロールバック**
   - 運営用の審査フロー（承認待ち一覧 → 承認/差戻）を `admin` 側に追加。
   - ダッシュボードで編集された履歴を差分で確認できる画面、または CSV 出力を準備。
   - 障害時に店舗更新を無効化する feature flag（`DASHBOARD_READONLY=true`）を実装。

## 優先度別スプリント案
| Sprint | 目的 | 主な作業 |
| --- | --- | --- |
| Sprint 1 | 認証とメール基盤固め | 招待 API / DB マイグレーション、SendGrid 連携、Magic Link テンプレ整備、CI シークレット登録 |
| Sprint 2 | 権限 & 編集ガード | ダッシュボード API の認可実装、変更対象フィールドの精査、操作ログ追加、店舗向け UI のバリデーション強化 |
| Sprint 3 | 運営・サポート整備 | 承認フロー、監査ログ UI、問い合わせチャネル準備、店舗向けドキュメント配布、Playwright/UAT |

## リスクと検討事項
- **迷惑メール判定**: ドメイン新設直後は迷惑メール行きの可能性が高い。テスト送信と SPF/DKIM の早期整備が必須。
- **多店舗運用**: 複数プロフィールを持つアカウント、複数メールアドレスを同一プロフィールへ割り当てる要件があるか確認。
- **編集競合**: 複数担当者が同時編集する場合の競合対策やロック機構は今後の課題。
- **モバイル最適化**: 店舗担当者がスマホから操作するシナリオを想定し、UI をモバイル対応で検証する。

## 次アクション（すぐ着手できる項目）
1. `dashboard_users` テーブルと対応する SQLAlchemy モデルを追加。
2. `/api/dashboard/auth/invite`（POST）と `/api/dashboard/auth/resend`（POST）を実装し、招待リンクを送信するバックエンドを整備。
3. SendGrid などのメールサービス決定 → API キーを Secret Manager に登録 → Cloud Run への環境変数反映を CI へ追加。
4. Playwright の管理画面テストにダッシュボードログインフローを追加し、CI でマジックリンク検証を自動化。

