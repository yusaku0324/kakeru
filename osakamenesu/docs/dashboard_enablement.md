# 店舗向けダッシュボード公開に向けた対応項目

## 現状の把握
- `/dashboard` 配下の UI、Magic Link 認証、Cloud Run へのデプロイまでは整備済み。
- ログインリンクは `scripts/dev_magic_link.sh` など開発者向けツールで発行しており、店舗側には共有されていない。
- メール送信は Cloud Run ログに `MAGIC_LINK_DEBUG` を書き出すデバッグ用途のみで、本番ドメインや DKIM 設定が未整備。
- 店舗プロフィールとログインユーザーの関連付けは手動前提（Seed 実行時に作成したダミーアカウントのみ）。
- 運営側が更新内容を把握する仕組み（履歴、承認フロー、サポート窓口）がない。

## 最近の進捗
- `dashboard_users` テーブルと SQLAlchemy モデルを追加し、招待メールの状態管理が可能に。
- `/api/admin/dashboard/users/invite` を実装し、Resend 経由で招待メールを送信／再送できるようにした。
- 管理画面 `/admin/shops` に招待フォームとステータス表示を追加し、運営 UI から招待操作を完結できるようにした。
- CI (`ci.yml`) で `MAIL_APIKEY` などの Cloud Run 反映を自動化（DNS 認証完了後にシークレットを流し込むだけで稼働）。

## 必須タスク
1. **アカウント発行・招待フロー**
   - ✅ 店舗メールアドレス単位で招待〜再送を行える管理 API / UI を実装済み
   - ⏳ 招待取り消し・承認／差戻しフローの整備

2. **メール配送基盤**
   - 送信元ドメイン（例: `notify.osakamenesu.jp`）を決定し、SPF/DKIM/DMARC を設定。
   - ✅ Resend を選定し、CI／コード側で利用できるよう下地を作成。
   - ⏳ DNS 認証完了後に本番ドメインの送信テスト、テンプレート文面の確定。

3. **権限と API サイドの整備**
   - `dashboard_users` と `profiles` を参照する認可チェックを `/api/dashboard/*` に実装（現在は Seed ユーザー前提で簡易チェック）。
   - 店舗側が編集可能なフィールドをスキーマで定義し、不可視フィールドへのアクセスを禁止。
   - 操作ログ (`admin_change_logs` など) に店舗ユーザーの ID を記録し、運営が監査できるようにする。

4. **UI/UX の安全策**
   - 入力バリデーション、下書き保存、公開前プレビューを実装し、誤操作時のアラートを整備。
   - 重要フィールド変更時に運営へ Slack/メール通知する仕組みを追加。
   - 利用ガイド・FAQ を `/dashboard/help` に用意し、問い合わせ窓口を案内。

5. **サポートとロールバック**
   - 運営用の審査フロー（承認待ち一覧 → 承認/差戻）を `admin` 側に追加。
   - ダッシュボードで編集された履歴を差分で確認できる画面、または CSV 出力を準備。
   - 障害時に店舗更新を無効化する feature flag（`DASHBOARD_READONLY=true`）を実装。

## 優先度別スプリント案
| Sprint | 目的 | 主な作業 |
| --- | --- | --- |
| Sprint 1 | 認証とメール基盤固め | 招待 API / DB マイグレーション、SendGrid 連携、Magic Link テンプレ整備、CI シークレット登録 |
| Sprint 2 | 権限 & 編集ガード | ダッシュボード API の認可実装、変更対象フィールドの精査、操作ログ追加、店舗向け UI のバリデーション強化 |
| Sprint 3 | 運営・サポート整備 | 承認フロー、監査ログ UI、問い合わせチャネル準備、店舗向けドキュメント配布、Playwright/UAT |

## リスクと検討事項
- **迷惑メール判定**: ドメイン新設直後は迷惑メール行きの可能性が高い。テスト送信と SPF/DKIM の早期整備が必須。
- **多店舗運用**: 複数プロフィールを持つアカウント、複数メールアドレスを同一プロフィールへ割り当てる要件があるか確認。
- **編集競合**: 複数担当者が同時編集する場合の競合対策やロック機構は今後の課題。
- **モバイル最適化**: 店舗担当者がスマホから操作するシナリオを想定し、UI をモバイル対応で検証する。

## 次アクション（すぐ着手できる項目）
1. Resend ドメイン認証を完了させ、`MAIL_APIKEY` / `MAIL_FROM_ADDRESS` を Secrets / Cloud Run に登録 → ステージングで招待メール送信を実地確認。
2. 招待 API のユニットテスト・Playwright シナリオを追加し、CI で回帰できるようにする。
3. 招待承認／差戻しフローと、`dashboard_users.status` を変更できる管理 UI / API を設計。
4. `/api/dashboard/*` の認可を `dashboard_users` と連携させ、店舗担当者のみが該当プロフィールを編集できるようにする。
