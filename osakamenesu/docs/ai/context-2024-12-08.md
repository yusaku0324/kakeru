# 大阪メンエス.com プロジェクトコンテキスト (2024-12-08)

## プロジェクト概要

大阪エリア向けメンズエステ予約・検索プラットフォーム。
ゲスト（顧客）向け検索・マッチング・予約、店舗向け管理機能を提供。

## 技術スタック

### Backend (FastAPI)
- **場所**: `services/api/`
- **フレームワーク**: FastAPI + SQLAlchemy (async) + Alembic
- **DB**: PostgreSQL (Supabase)
- **検索**: Meilisearch (フォールバック: PostgreSQL)
- **デプロイ**: Fly.io (`osakamenesu-api`)

### Frontend (Next.js)
- **場所**: `apps/web/`
- **フレームワーク**: Next.js 14 (App Router) + TypeScript
- **スタイル**: Tailwind CSS + shadcn/ui
- **デプロイ**: Vercel

## ディレクトリ構造

```
osakamenesu/
├── apps/web/                 # Next.js フロントエンド
│   ├── src/app/
│   │   ├── admin/           # 管理画面
│   │   ├── guest/           # ゲスト向けページ
│   │   ├── search/          # 検索ページ
│   │   ├── shops/           # 店舗ページ
│   │   ├── therapist/       # セラピスト詳細
│   │   └── therapists/      # セラピスト一覧
│   └── e2e/                  # Playwright E2E テスト
│
├── services/api/             # FastAPI バックエンド
│   ├── app/
│   │   ├── domains/
│   │   │   ├── admin/       # 管理API
│   │   │   ├── site/        # 顧客向けAPI
│   │   │   │   ├── guest_matching.py    # マッチング・検索API
│   │   │   │   ├── shops.py             # 店舗API
│   │   │   │   ├── therapists.py        # セラピストAPI
│   │   │   │   ├── guest_reservations.py # 予約API
│   │   │   │   └── services/
│   │   │   │       └── shop/
│   │   │   │           ├── therapists_service.py
│   │   │   │           └── recommended_scoring_service.py
│   │   │   ├── dashboard/   # ダッシュボードAPI
│   │   │   └── auth/        # 認証API (LINE OAuth対応)
│   │   ├── models.py        # SQLAlchemyモデル
│   │   └── tests/           # pytest テスト
│   └── alembic/              # DBマイグレーション
│
├── specs/                    # API仕様・設計ドキュメント
│   ├── meta.yaml            # 仕様インデックス
│   ├── matching/            # マッチング関連仕様
│   │   ├── core.yaml
│   │   ├── search.yaml
│   │   └── similar.yaml
│   └── reservations/        # 予約関連仕様
│
└── docs/                     # ドキュメント
    ├── backlog.md           # 機能バックログ
    └── ai/                  # AI向けコンテキスト
```

## 主要API一覧

### 顧客向け (Site)

| エンドポイント | 概要 | 実装ファイル |
|---------------|------|-------------|
| `GET /api/v1/shops` | 店舗検索 | `site/shops.py` |
| `GET /api/v1/shops/{id}` | 店舗詳細 | `site/shops.py` |
| `GET /api/v1/shops/{id}/therapists` | 店舗所属セラピスト | `site/shops.py` |
| `GET /api/guest/therapists/{id}` | セラピスト詳細 | `site/therapists.py` |
| `GET /api/guest/matching/search` | マッチング検索 | `site/guest_matching.py` |
| `GET /api/guest/matching/similar` | 類似セラピスト | `site/guest_matching.py` |
| `POST /api/guest/reservations` | 予約作成 | `site/guest_reservations.py` |

### 管理向け (Admin)
| エンドポイント | 概要 |
|---------------|------|
| `GET/POST /api/admin/shops` | 店舗CRUD |
| `GET/POST /api/admin/therapists` | セラピストCRUD |
| `GET/POST /api/admin/reservations` | 予約管理 |

## 最近の実装完了項目 (直近20コミット)

1. **recommended_score** - 店舗詳細・セラピスト詳細APIにおすすめスコアを追加
2. **LINE OAuth認証** - セラピストポータルのLINE連携
3. **2軸検索ナビゲーション** - セラピスト/店舗の検索UI
4. **E2Eテスト強化** - 店舗・セラピストページのE2Eテスト追加
5. **recommended_scoring_service** - フロントエンド同等のスコアリングロジック実装

## 現在のブランチ

`185-shop-page-api` - Shop Page API関連の開発

## 機能バックログ (優先度順)

### P0 (最優先)
- **BL-001**: 予約通知連携 (メール/SMS/LINE)
- **BL-002**: 店舗セルフ管理UI (ダッシュボード)

### P1
- **BL-003**: エンドユーザ会員ログイン/お気に入り
- **BL-004**: 地図・駅別検索/距離ソート

### P2
- **BL-005**: 広告メニュー管理 (PR枠/クーポン)
- **BL-006**: 観測性強化 (エラーレポート/トラッキング)

## スペック構成

```yaml
# specs/meta.yaml より
domains:
  frontend:
    - frontend.pages: UIページ仕様
  matching:
    - matching.core: マッチングリクエスト/レスポンス
    - matching.search: 検索API
    - matching.similar: 類似セラピストAPI
  reservations:
    - reservations.core: 予約管理
```

## 直近の変更

### 今回のセッション (2024-12-08)
- `matching.py` 削除 (ルートシャドウイング問題解決)
  - `guest_matching.py` と重複していた `/api/guest/matching/similar` エンドポイント
  - 変更ファイル:
    - `app/domains/site/__init__.py` - `matching_router` 削除
    - `app/main.py` - `matching_router` 登録削除
    - `app/domains/site/matching.py` - ファイル削除

### テスト結果
- `test_matching_similar.py`: 4 passed
- `test_shop_therapists_api.py`: 14 passed
- `test_guest_matching.py`: 14 passed

## 次の実装候補

1. **Shop Page API完成** - `specs/matching/shop_page.yaml` に基づく実装確認
2. **Therapist Detail API** - `specs/184-therapist-detail-api/`
3. **予約通知連携 (BL-001)** - バックログP0
4. **店舗ダッシュボード (BL-002)** - バックログP0

## 環境

- **Python**: 3.11
- **Node.js**: 18+
- **DB**: PostgreSQL (Supabase)
- **検索**: Meilisearch

## テストコマンド

```bash
# Backend
cd services/api
python -m pytest app/tests/ -v

# Frontend
cd apps/web
pnpm test
pnpm exec playwright test
```

## デプロイ

- **API**: `fly deploy` (Fly.io)
- **Web**: `vercel --prod` (Vercel)
