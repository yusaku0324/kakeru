# レート制限戦略

## 概要

Osakamenesuプロジェクトの多層レート制限によるDDoS対策とAPI保護戦略です。

## レート制限の階層

### 1. グローバル制限（DDoS対策）
- **制限**: 1000リクエスト/分/IP
- **目的**: 悪意のあるボットやDDoS攻撃の防御
- **対象**: すべてのエンドポイント

### 2. バースト制限
- **制限**: 100リクエスト/10秒/IP
- **目的**: 短時間の大量リクエストを防止
- **対象**: すべてのエンドポイント

### 3. 持続的トラフィック制限
- **制限**: 300リクエスト/分/IP
- **目的**: 通常利用の範囲内での制御
- **対象**: すべてのエンドポイント

### 4. エンドポイント別制限

#### 検索・閲覧API
- **制限**: 60リクエスト/分/IP
- **対象**: `/api/v1/shops`, `/api/v1/therapists`
- **理由**: 頻繁にアクセスされるが負荷は軽い

#### 予約作成API
- **制限**: 10リクエスト/時間/IP
- **対象**: `/api/v1/reservations`
- **理由**: 重要なビジネスロジックを保護

#### 認証API
- **制限**: 5リクエスト/10分/IP
- **対象**: `/api/v1/auth/*`
- **理由**: ブルートフォース攻撃の防止

## 実装詳細

### ミドルウェア構成

```python
# main.py での設定
from .middleware.enhanced_rate_limit import create_enhanced_rate_limiter

# Redisクライアントの設定
redis_client = from_url(settings.rate_limit_redis_url)

# グローバルレート制限の適用
app.add_middleware(
    create_enhanced_rate_limiter(redis_client)
)
```

### レスポンスヘッダー

成功時:
```
X-RateLimit-Limit-Sustained: 300
X-RateLimit-Window-Sustained: 60
```

制限時:
```
HTTP/1.1 429 Too Many Requests
Retry-After: 60
X-RateLimit-Limit: 1000
X-RateLimit-Window: 60
X-RateLimit-Tier: global
```

## IPアドレスの取得

優先順位:
1. `X-Forwarded-For` ヘッダー（プロキシ経由）
2. `X-Real-IP` ヘッダー（Nginx等）
3. 直接接続のIPアドレス

## 疑わしいIPの処理

1. グローバル制限に達したIPは「疑わしい」とマーク
2. 1時間のクールダウン期間中はすべてのリクエストをブロック
3. クールダウン後は自動的にリストから削除

## 除外パス

以下のパスはレート制限から除外:
- `/health`
- `/metrics`
- `/api/ops/health`
- `/api/ops/health/backup`
- `/.well-known/*`

## Redis障害時の動作

- Redisが利用不可能な場合、インメモリでの制限にフォールバック
- エラークールダウン期間（60秒）の設定
- ログでの障害記録

## 監視とアラート

### メトリクス

1. **レート制限発動数**
   - Tier別のカウント
   - IP別の統計

2. **疑わしいIPリスト**
   - ブロックされたIPの数
   - ブロック期間

### アラート設定

- レート制限発動が100回/分を超えた場合
- 疑わしいIPが10個以上検出された場合
- Redis接続エラーが発生した場合

## チューニングガイド

### 制限値の調整

正当なユーザーをブロックしないよう、以下の指標を監視:
- 平均的なユーザーのリクエスト頻度
- ピーク時のトラフィック
- エラー率

### 推奨値

| ユーザータイプ | 推奨制限 |
|---|---|
| 一般ユーザー | 300/分 |
| モバイルアプリ | 500/分 |
| パートナーAPI | 1000/分 |

## セキュリティベストプラクティス

1. **ログの記録**
   - すべてのレート制限イベントをログに記録
   - IPアドレス、パス、時刻を含める

2. **定期的なレビュー**
   - 月次でレート制限の効果を評価
   - 必要に応じて制限値を調整

3. **ホワイトリスト**
   - 信頼できるIPアドレスの管理
   - 内部サービスの除外設定

## トラブルシューティング

### 正当なユーザーがブロックされる場合

1. ログを確認してリクエストパターンを分析
2. 制限値が適切か評価
3. 必要に応じて特定のパスの制限を緩和

### レート制限が効かない場合

1. Redis接続を確認
2. ミドルウェアの適用順序を確認
3. IPアドレスの取得方法を検証

## 今後の改善案

1. **ユーザー別レート制限**
   - 認証済みユーザーには緩い制限
   - 有料プランでの制限緩和

2. **動的レート制限**
   - トラフィックパターンに基づく自動調整
   - 機械学習による異常検知

3. **分散レート制限**
   - 複数リージョンでの協調制御
   - エッジでの制限実装
