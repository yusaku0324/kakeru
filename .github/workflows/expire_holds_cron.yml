name: expire_holds cron

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: read

concurrency:
  group: expire-holds-cron
  cancel-in-progress: false

jobs:
  expire_holds_prod:
    name: "ops: expire_holds (prod)"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      API_BASE: https://api.osakamenesu.com
      OPS_TOKEN: ${{ secrets.OPS_TOKEN_PROD }}
    steps:
      - name: Skip (OPS_TOKEN_PROD missing)
        if: ${{ env.OPS_TOKEN == '' }}
        run: echo "OPS_TOKEN_PROD is not set; skipping."

      - name: Call expire_holds (prod)
        if: ${{ env.OPS_TOKEN != '' }}
        run: |
          set -euo pipefail
          response_file="$(mktemp)"
          trap 'rm -f "$response_file"' EXIT

          http_code="$(
            curl -sS -o "$response_file" -w '%{http_code}' --max-time 30 \
              -X POST "$API_BASE/api/ops/reservations/expire_holds" \
              -H "Authorization: Bearer $OPS_TOKEN"
          )"

          echo "http_code=$http_code"
          python - "$response_file" <<'PY'
          import json
          import pathlib
          import sys

          data = json.loads(pathlib.Path(sys.argv[1]).read_text())
          print(f"expired={data.get('expired')} now={data.get('now')}")
          PY

          if [[ "$http_code" -lt 200 || "$http_code" -ge 300 ]]; then
            echo "Response body:"
            cat "$response_file"
            exit 1
          fi

  expire_holds_stg:
    name: "ops: expire_holds (stg)"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      API_BASE: https://osakamenesu-api-stg.fly.dev
      OPS_TOKEN: ${{ secrets.OPS_TOKEN_STG }}
    steps:
      - name: Skip (OPS_TOKEN_STG missing)
        if: ${{ env.OPS_TOKEN == '' }}
        run: echo "OPS_TOKEN_STG is not set; skipping."

      - name: Call expire_holds (stg)
        if: ${{ env.OPS_TOKEN != '' }}
        run: |
          set -euo pipefail
          response_file="$(mktemp)"
          trap 'rm -f "$response_file"' EXIT

          http_code="$(
            curl -sS -o "$response_file" -w '%{http_code}' --max-time 30 \
              -X POST "$API_BASE/api/ops/reservations/expire_holds" \
              -H "Authorization: Bearer $OPS_TOKEN"
          )"

          echo "http_code=$http_code"
          python - "$response_file" <<'PY'
          import json
          import pathlib
          import sys

          data = json.loads(pathlib.Path(sys.argv[1]).read_text())
          print(f"expired={data.get('expired')} now={data.get('now')}")
          PY

          if [[ "$http_code" -lt 200 || "$http_code" -ge 300 ]]; then
            echo "Response body:"
            cat "$response_file"
            exit 1
          fi
