name: expire_holds cron

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: read

concurrency:
  group: expire-holds-cron
  cancel-in-progress: false

jobs:
  expire_holds_prod:
    name: "ops: expire_holds (prod)"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      API_BASE: https://api.osakamenesu.com
      OPS_TOKEN: ${{ secrets.OPS_TOKEN_PROD }}
    steps:
      - name: Skip (OPS_TOKEN_PROD missing)
        if: ${{ env.OPS_TOKEN == '' }}
        run: echo "OPS_TOKEN_PROD is not set; skipping."

      - name: Call expire_holds (prod)
        if: ${{ env.OPS_TOKEN != '' }}
        run: |
          set -euo pipefail
          response_file="$(mktemp)"
          trap 'rm -f "$response_file"' EXIT

          for attempt in 1 2 3; do
            http_code="$(
              curl -sS -o "$response_file" -w '%{http_code}' --max-time 30 \
                -X POST "$API_BASE/api/ops/reservations/expire_holds" \
                -H "Authorization: Bearer $OPS_TOKEN"
            )"

            echo "attempt=$attempt http_code=$http_code"
            if [[ "$http_code" -ge 200 && "$http_code" -lt 300 ]]; then
              python -c 'import json,sys; data=json.load(open(sys.argv[1])); print("expired=%s now=%s" % (data.get("expired"), data.get("now")))' "$response_file"
              exit 0
            fi

            echo "Response body (first 2000 bytes):"
            head -c 2000 "$response_file" || true
            echo
            sleep "$((attempt * 5))"
          done

          exit 1

  expire_holds_stg:
    name: "ops: expire_holds (stg)"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      API_BASE: https://osakamenesu-api-stg.fly.dev
      OPS_TOKEN: ${{ secrets.OPS_TOKEN_STG }}
    steps:
      - name: Skip (OPS_TOKEN_STG missing)
        if: ${{ env.OPS_TOKEN == '' }}
        run: echo "OPS_TOKEN_STG is not set; skipping."

      - name: Call expire_holds (stg)
        if: ${{ env.OPS_TOKEN != '' }}
        run: |
          set -euo pipefail
          response_file="$(mktemp)"
          trap 'rm -f "$response_file"' EXIT

          for attempt in 1 2 3; do
            http_code="$(
              curl -sS -o "$response_file" -w '%{http_code}' --max-time 30 \
                -X POST "$API_BASE/api/ops/reservations/expire_holds" \
                -H "Authorization: Bearer $OPS_TOKEN"
            )"

            echo "attempt=$attempt http_code=$http_code"
            if [[ "$http_code" -ge 200 && "$http_code" -lt 300 ]]; then
              python -c 'import json,sys; data=json.load(open(sys.argv[1])); print("expired=%s now=%s" % (data.get("expired"), data.get("now")))' "$response_file"
              exit 0
            fi

            echo "Response body (first 2000 bytes):"
            head -c 2000 "$response_file" || true
            echo
            sleep "$((attempt * 5))"
          done

          exit 1
