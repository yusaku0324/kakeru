name: CI

on:
  push:
    branches: [ main ]        # feature ブランチでも回したい場合は '**'
  pull_request:

jobs:
  test:
    runs-on: macos-latest     # 必要なら ubuntu-latest などに変更
    env:
      # 書き込み可能な場所へ変更（例: ランナー作業ディレクトリ直下）
      RUNNER_TOOL_CACHE: ${{ github.workspace }}/_toolcache
      AGENT_TOOLSDIRECTORY: ${{ github.workspace }}/_toolcache

    steps:
      - uses: actions/checkout@v4

      - name: Prepare toolcache dir
        run: mkdir -p "$RUNNER_TOOL_CACHE"

      # Work-around: actions/setup-python on self-hosted mac ignores env vars
      # and tries to create /Users/runner/hostedtoolcache. Pre-create it with
      # write permission (or symlink) to avoid "Permission denied".
      - name: Workaround setup-python permission issue
        run: |
          sudo mkdir -p /Users/runner/hostedtoolcache || true
          sudo chmod -R 777 /Users/runner || true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'   # 3.12 が不要なら固定も可
          cache: 'pip'

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Run tests
        run: pytest -q 