name: API Integration Tests

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'services/api/**'
      - 'osakamenesu/services/api/**'
      - 'docker/api.Dockerfile'
      - 'osakamenesu/docker/api.Dockerfile'
      - 'docker-compose.test.yml'
      - 'osakamenesu/docker-compose.test.yml'
      - 'requirements-test.txt'
      - 'osakamenesu/requirements-test.txt'
      - '.github/workflows/ci-api-integration.yml'
  pull_request:
    paths:
      - 'services/api/**'
      - 'osakamenesu/services/api/**'
      - 'docker/api.Dockerfile'
      - 'osakamenesu/docker/api.Dockerfile'
      - 'docker-compose.test.yml'
      - 'osakamenesu/docker-compose.test.yml'
      - 'requirements-test.txt'
      - 'osakamenesu/requirements-test.txt'
      - '.github/workflows/ci-api-integration.yml'

jobs:
  integration-tests:
    name: "api: integration tests"
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
          POSTGRES_DB: osaka_menesu
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U app"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      meilisearch:
        image: getmeili/meilisearch:v1.11
        env:
          MEILI_MASTER_KEY: test_master_key
        ports:
          - 7700:7700

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Resolve API_DIR
        id: resolve-int
        run: |
          set -e
          candidates=$(find . -maxdepth 5 -type f -path '*/app/enums.py' | sed 's#/app/enums.py##')
          echo "Found candidates:"
          echo "$candidates"
          API_DIR=$(echo "$candidates" | head -n1)
          if [ -z "$API_DIR" ]; then
            echo "❌ app/enums.py not found under repo"
            exit 1
          fi
          echo "API_DIR=$API_DIR" >> "$GITHUB_ENV"
          echo "api_dir=$API_DIR" >> "$GITHUB_OUTPUT"
          echo "Resolved API_DIR=$API_DIR"
          ls -la "$API_DIR"

      - name: Install dependencies
        env:
          API_DIR: ${{ steps.resolve-int.outputs.api_dir }}
        run: |
          cd "${API_DIR}"
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r ../../requirements-test.txt

      - name: Wait for services
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:7700/health >/dev/null 2>&1; then
              echo "Meilisearch is ready"
              break
            fi
            echo "Waiting for Meilisearch... ($i/30)"
            sleep 2
          done

      - name: Run Alembic migrations
        env:
          API_DIR: ${{ steps.resolve-int.outputs.api_dir }}
          DATABASE_URL: postgresql+asyncpg://app:app@localhost:5432/osaka_menesu
          MEILI_HOST: http://localhost:7700
          MEILI_MASTER_KEY: test_master_key
        run: |
          cd "${API_DIR}"
          alembic upgrade head

      - name: Run unit tests
        env:
          API_DIR: ${{ steps.resolve-int.outputs.api_dir }}
          DATABASE_URL: postgresql+asyncpg://app:app@localhost:5432/osaka_menesu
          MEILI_HOST: http://localhost:7700
          MEILI_MASTER_KEY: test_master_key
          ADMIN_API_KEY: test_admin_key
          API_ORIGIN: http://localhost:3000
          RATE_LIMIT_REDIS_URL: ""
        run: |
          cd "${API_DIR}"
          pytest app/tests -m "not integration" -q --tb=short

      - name: Run integration tests
        env:
          API_DIR: ${{ steps.resolve-int.outputs.api_dir }}
          DATABASE_URL: postgresql+asyncpg://app:app@localhost:5432/osaka_menesu
          MEILI_HOST: http://localhost:7700
          MEILI_MASTER_KEY: test_master_key
          ADMIN_API_KEY: test_admin_key
          API_ORIGIN: http://localhost:3000
          RATE_LIMIT_REDIS_URL: ""
        run: |
          cd "${API_DIR}"
          pytest app/tests_integration -m integration -q --tb=short || echo "No integration tests found, skipping"

  dependency-check:
    name: "api: dependency check"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Resolve API_DIR
        id: resolve-deps
        run: |
          set -e
          candidates=$(find . -maxdepth 5 -type f -path '*/app/enums.py' | sed 's#/app/enums.py##')
          echo "Found candidates:"
          echo "$candidates"
          API_DIR=$(echo "$candidates" | head -n1)
          if [ -z "$API_DIR" ]; then
            echo "❌ app/enums.py not found under repo"
            exit 1
          fi
          echo "API_DIR=$API_DIR" >> "$GITHUB_ENV"
          echo "api_dir=$API_DIR" >> "$GITHUB_OUTPUT"
          echo "Resolved API_DIR=$API_DIR"
          ls -la "$API_DIR"

      - name: Check for missing dependencies
        env:
          API_DIR: ${{ steps.resolve-deps.outputs.api_dir }}
        run: |
          cd "${API_DIR}"
          python -m pip install --upgrade pip
          pip install -r requirements.txt

          python - <<'PY'
          import sys
          sys.path.insert(0, '.')

          try:
              from app.main import app
              print('✅ app.main imports successfully')
          except ImportError as e:
              print(f'❌ Import error in app.main: {e}')
              sys.exit(1)

          try:
              from app.domains.site.guest_matching import guest_matching_search
              print('✅ guest_matching imports successfully')
          except ImportError as e:
              print(f'❌ Import error in guest_matching: {e}')
              sys.exit(1)
          PY

  enum-consistency-check:
    name: "api: enum consistency"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Resolve API_DIR
        id: resolve-enum
        run: |
          set -e
          candidates=$(find . -maxdepth 5 -type f -path '*/app/enums.py' | sed 's#/app/enums.py##')
          echo "Found candidates:"
          echo "$candidates"
          API_DIR=$(echo "$candidates" | head -n1)
          if [ -z "$API_DIR" ]; then
            echo "❌ app/enums.py not found under repo"
            exit 1
          fi
          echo "API_DIR=$API_DIR" >> "$GITHUB_ENV"
          echo "api_dir=$API_DIR" >> "$GITHUB_OUTPUT"
          echo "Resolved API_DIR=$API_DIR"
          ls -la "$API_DIR"

      - name: Check enum consistency
        env:
          API_DIR: ${{ steps.resolve-enum.outputs.api_dir }}
        run: |
          cd "${API_DIR}"
          python - <<'PY'
          import re
          import sys
          from pathlib import Path

          errors = []

          enums_path = Path('app/enums.py')
          if not enums_path.exists():
              print('❌ app/enums.py not found - enum definitions should be centralized')
              sys.exit(1)

          enums_content = enums_path.read_text()

          values_pattern = r'(\w+_VALUES):\s*Tuple\[str,\s*\.\.\.\]\s*=\s*\(([^)]+)\)'
          enum_values = {}
          for match in re.finditer(values_pattern, enums_content):
              name = match.group(1)
              values_str = match.group(2)
              values = [v.strip().strip('"').strip("'") for v in values_str.split(',') if v.strip()]
              enum_values[name] = set(values)
              print(f'Found {name}: {values}')

          # Check models (may be a package/directory or single file)
          models_dir = Path('app/models')
          if models_dir.is_dir():
              # models is a package - check if any file imports from enums
              has_enum_import = False
              for py_file in models_dir.glob('*.py'):
                  content = py_file.read_text()
                  if 'from ..enums import' in content or 'from app.enums import' in content:
                      has_enum_import = True
                      break
              if not has_enum_import:
                  errors.append('models package should import enum values from enums.py')
          else:
              models_path = Path('app/models.py')
              if models_path.exists():
                  models_content = models_path.read_text()
                  if 'from .enums import' not in models_content and 'from app.enums import' not in models_content:
                      errors.append('models.py should import enum values from enums.py')

          # Check schemas (may be a package/directory or single file)
          schemas_dir = Path('app/schemas')
          if schemas_dir.is_dir():
              # schemas is a package - check if any file imports from enums
              has_enum_import = False
              for py_file in schemas_dir.glob('*.py'):
                  content = py_file.read_text()
                  if 'from ..enums import' in content or 'from app.enums import' in content:
                      has_enum_import = True
                      break
              if not has_enum_import:
                  errors.append('schemas package should import enum Literals from enums.py')
          else:
              schemas_path = Path('app/schemas.py')
              if schemas_path.exists():
                  schemas_content = schemas_path.read_text()
                  if 'from .enums import' not in schemas_content and 'from app.enums import' not in schemas_content:
                      errors.append('schemas.py should import enum Literals from enums.py')

          api_dir = Path('app')
          for py_file in api_dir.rglob('*.py'):
              if 'test' in str(py_file) or 'alembic' in str(py_file) or 'enums.py' in str(py_file):
                  continue
              content = py_file.read_text()
              if re.search(r'therapist.*status.*["\']active["\']', content, re.IGNORECASE):
                  for i, line in enumerate(content.split('\n'), 1):
                      if "'active'" in line or '"active"' in line:
                          if 'therapist' in line.lower() and 'status' in line.lower():
                              errors.append(f'{py_file}:{i}: Found hardcoded "active" status (use enums.py values)')

          if errors:
              print('\n❌ Enum consistency errors found:')
              for error in errors:
                  print(f'  - {error}')
              sys.exit(1)
          else:
              print('\n✅ All enum checks passed')
          PY
