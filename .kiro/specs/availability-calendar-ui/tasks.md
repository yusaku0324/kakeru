# Availability Calendar UI/API Implementation Tasks

## 概要

本タスクリストは、requirements.mdとdesign.mdで定義された仕様を実装するための具体的な作業項目を示す。各タスクは独立して実行可能で、段階的にシステムを改善できるよう設計されている。

## Phase 1: API修正（高優先度）

### 1.1 AvailabilitySlotsResponse に status フィールド追加

- [ ] **API レスポンス修正**
  - `app/domains/site/therapist_availability.py` の `AvailabilitySlotResponse` に `status` フィールド追加
  - `status: AvailabilityStatus` を必須フィールドとして定義
  - `AvailabilityStatus = Literal["open", "tentative", "blocked"]` の型定義追加
  - _要件: requirements.md「API レスポンス仕様」_

- [ ] **ステータス計算ロジック実装**
  - `determine_slot_status()` 関数を実装
  - SoT（TherapistShift + GuestReservation）からステータス決定
  - 過去時刻の自動blocked化
  - _要件: requirements.md「ステータス定義」_

- [ ] **レスポンス生成修正**
  - 30分単位スロット生成時にstatusを含める
  - JST基準での時間枠生成を確認
  - `availability_slots` エンドポイントの出力形式統一
  - _要件: design.md「API実装設計」_

### 1.2 スロット検証API実装

- [ ] **検証エンドポイント追加**
  - `GET /api/guest/therapists/{id}/availability_slots?verify_slot={start_at}` 実装
  - 単一スロットの最新状態を返却
  - `verified_at` タイムスタンプ追加
  - _要件: design.md「検証API仕様」_

- [ ] **競合エラーレスポンス実装**
  - 409 Conflict ステータスコード
  - 構造化されたエラー詳細情報
  - `conflicted_at` タイムスタンプ
  - _要件: requirements.md「エラーハンドリング」_

### 1.3 API テスト追加

- [ ] **単体テスト**
  - `test_availability_slots_status_field()` - statusフィールド存在確認
  - `test_slot_status_calculation()` - ステータス決定ロジック
  - `test_verify_slot_endpoint()` - 検証API動作確認
  - _要件: design.md「テスト設計方針」_

- [ ] **統合テスト**
  - SoT計算結果とAPIレスポンスの整合性
  - JST/UTC変換の正確性
  - エラーケースの網羅的テスト
  - _要件: requirements.md「バリデーションルール」_

## Phase 2: フロントエンド UI修正（高優先度）

### 2.1 アイコン統一

- [ ] **アイコン定義統一**
  - `◎` (open), `△` (tentative), `×` (blocked) に統一
  - 既存の `●` アイコンを `◎` に変更
  - CSS クラス `.availability-icon--{status}` 実装
  - _要件: requirements.md「アイコン・色・UI制約の統一定義」_

- [ ] **アイコンコンポーネント実装**
  - `StatusIcon` コンポーネント作成
  - アクセシビリティ対応（aria-label, sr-only）
  - 色覚多様性対応（色+アイコン併用）
  - _要件: design.md「React コンポーネント設計」_

### 2.2 blocked セルの disabled 化

- [ ] **CSS 制約実装**
  - `pointer-events: none` 適用
  - `cursor: not-allowed` 設定
  - `opacity: 0.6` で視覚的に無効化表示
  - _要件: requirements.md「カレンダーUIの振る舞い」_

- [ ] **React コンポーネント修正**
  - `AvailabilityCell` に `disabled` 属性追加
  - `tabIndex={-1}` でキーボードナビゲーション除外
  - クリックイベントハンドラーでの早期リターン
  - _要件: design.md「AvailabilityCell コンポーネント」_

### 2.3 状態管理実装

- [ ] **React State 構造実装**
  - `AvailabilityCalendarState` インターフェース定義
  - `selectedSlot` 単一選択管理
  - `conflictError` エラー状態管理
  - _要件: design.md「状態管理設計」_

- [ ] **状態遷移ロジック実装**
  - セル選択時の tentative 状態設定
  - 既存選択の自動解除（単一選択）
  - セル選択解除時の open 状態復帰
  - _要件: requirements.md「インタラクション仕様」_

## Phase 3: リアルタイム検証実装（高優先度）

### 3.1 予約前検証フロー

- [ ] **検証API呼び出し実装**
  - 予約確定前の自動検証
  - `verifySlot()` 関数実装
  - ローディング状態管理（`isVerifying`）
  - _要件: design.md「リアルタイム検証フローの詳細設計」_

- [ ] **競合エラー処理実装**
  - 409 Conflict レスポンス処理
  - エラーメッセージ表示（3秒間）
  - カレンダー最新状態への自動更新
  - tentative セルの自動解除
  - _要件: requirements.md「競合時のUI表示」_

### 3.2 エラー表示UI実装

- [ ] **エラーメッセージコンポーネント**
  - カレンダー上部への表示
  - 自動非表示タイマー（3秒）
  - 該当セルのハイライト表示
  - _要件: design.md「フロントエンドエラー処理」_

- [ ] **エラー状態管理**
  - `ConflictError` インターフェース実装
  - `showUntil` による自動非表示制御
  - エラー解除時の状態クリア
  - _要件: requirements.md「リアルタイム検証要件」_

## Phase 4: E2E テスト実装（中優先度）

### 4.1 基本操作テスト

- [ ] **カレンダー表示テスト**
  - 7日分のカレンダー正常表示
  - 各ステータス（open/tentative/blocked）の視覚確認
  - アイコンと色の正確性確認
  - _要件: requirements.md「成功条件」_

- [ ] **セル操作テスト**
  - open セルクリックで tentative 化
  - tentative セルクリックで open 化
  - blocked セルのクリック不可確認
  - 単一選択の動作確認
  - _要件: requirements.md「インタラクション仕様」_

### 4.2 予約競合検証テスト

- [ ] **競合シナリオテスト**
  - 他ユーザーによる同時予約の検出
  - 競合エラーメッセージの表示確認
  - カレンダー自動更新の動作確認
  - _要件: design.md「検証シーケンス図」_

- [ ] **エラー回復テスト**
  - エラー表示後の正常操作復帰
  - 3秒後の自動エラー非表示
  - 別時間枠での予約成功
  - _要件: requirements.md「エラーハンドリング」_

### 4.3 アクセシビリティテスト

- [ ] **キーボード操作テスト**
  - Tab キーでのセル間移動
  - Enter キーでのセル選択
  - Escape キーでの選択解除
  - _要件: requirements.md「アクセシビリティ要件」_

- [ ] **スクリーンリーダーテスト**
  - aria-label の音声読み上げ確認
  - role="grid" の構造認識確認
  - 状態変更時の aria-live 通知確認
  - _要件: requirements.md「スクリーンリーダー対応」_

## Phase 5: パフォーマンス最適化（低優先度）

### 5.1 フロントエンド最適化

- [ ] **レンダリング最適化**
  - `React.memo` による不要再レンダリング防止
  - `useMemo` による計算結果キャッシュ
  - `useCallback` によるイベントハンドラー最適化
  - _要件: design.md「フロントエンド最適化」_

- [ ] **仮想化実装（大量データ対応）**
  - `react-window` による仮想スクロール
  - 表示領域外セルの遅延レンダリング
  - メモリ使用量の最適化
  - _要件: design.md「VirtualizedCalendar」_

### 5.2 バックエンド最適化

- [ ] **クエリ最適化**
  - N+1問題の完全解消
  - バッチクエリによる一括データ取得
  - インデックス最適化
  - _要件: design.md「バックエンド最適化」_

- [ ] **キャッシュ戦略実装**
  - Redis による計算結果キャッシュ
  - キャッシュ無効化戦略
  - キャッシュヒット率監視
  - _要件: final-sot-specification.md準拠_

## Phase 6: 追加機能・改善（低優先度）

### 6.1 モバイル対応

- [ ] **レスポンシブデザイン**
  - モバイル端末での操作性向上
  - タッチ操作の最適化
  - 画面サイズ別レイアウト調整
  - _要件: requirements.md「成功条件」_

- [ ] **AvailabilityPickerMobile 実装**
  - モバイル専用UI コンポーネント
  - スワイプ操作対応
  - 縦画面レイアウト最適化
  - _要件: 将来改善項目_

### 6.2 色覚多様性対応強化

- [ ] **パターン併用実装**
  - 色だけでなくパターンでの状態区別
  - ハッチング、ドット等の視覚パターン
  - 高コントラスト比の確保
  - _要件: requirements.md「色覚多様性対応」_

- [ ] **カラーテーマ選択**
  - 複数のカラーパレット提供
  - ユーザー設定による切り替え
  - WCAG 2.1 AA準拠の確認
  - _要件: 将来改善項目_

## 実装時のチェックリスト

### 各Phase完了時の確認項目

#### Phase 1 完了時
- [ ] API レスポンスに `status` フィールドが含まれる
- [ ] ステータス値が `"open"`, `"tentative"`, `"blocked"` のいずれか
- [ ] 検証API が正常に動作する
- [ ] エラーレスポンスが仕様通りの構造

#### Phase 2 完了時
- [ ] アイコンが `◎`, `△`, `×` に統一されている
- [ ] blocked セルがクリック不可能
- [ ] 単一選択が正常に動作する
- [ ] 状態遷移が仕様通り

#### Phase 3 完了時
- [ ] 予約前検証が自動実行される
- [ ] 競合エラーが適切に表示される
- [ ] エラー後のカレンダー更新が動作する
- [ ] 3秒後の自動エラー非表示が動作する

#### Phase 4 完了時
- [ ] 全ての基本操作がE2Eテストでカバーされる
- [ ] 競合シナリオがテストされる
- [ ] アクセシビリティ要件が満たされる
- [ ] テスト成功率が95%以上

### コードレビュー時の確認項目

#### API実装
- [ ] SoT（TherapistShift + GuestReservation）のみを参照している
- [ ] slots_json を UI判定に使用していない
- [ ] JST基準での時間処理が正しい
- [ ] エラーハンドリングが適切

#### フロントエンド実装
- [ ] アクセシビリティ属性が適切に設定されている
- [ ] 状態管理が仕様通り
- [ ] エラー処理が網羅的
- [ ] パフォーマンスに問題がない

#### テスト実装
- [ ] 境界条件がテストされている
- [ ] エラーケースがカバーされている
- [ ] アクセシビリティがテストされている
- [ ] パフォーマンス要件が満たされている

## 完了条件

### 機能完了条件
- [ ] 全てのPhase 1-3タスクが完了している
- [ ] E2Eテストが全て成功している
- [ ] パフォーマンス要件（1秒以内表示、500ms以内検証）を満たしている
- [ ] アクセシビリティ基準（WCAG 2.1 AA）を満たしている

### 品質完了条件
- [ ] コードカバレッジが90%以上
- [ ] 静的解析エラーが0件
- [ ] セキュリティ脆弱性が0件
- [ ] ドキュメントが最新状態

### 運用完了条件
- [ ] 本番環境での動作確認完了
- [ ] 監視・アラート設定完了
- [ ] 運用手順書作成完了
- [ ] チーム内での仕様共有完了

## リスクと対策

### 技術リスク
- **リスク**: API変更による既存機能への影響
- **対策**: 段階的リリース、フィーチャーフラグ使用

### スケジュールリスク
- **リスク**: E2Eテスト実装の遅延
- **対策**: Phase 1-3を優先、Phase 4は並行実行

### 品質リスク
- **リスク**: アクセシビリティ要件の見落とし
- **対策**: 各Phase完了時の専門チェック実施

## 注意事項

### 実装時の禁止事項
- slots_json をUI判定に使用すること
- 新しいステータス（open/tentative/blocked以外）を追加すること
- SoT仕様と矛盾する実装をすること
- アクセシビリティ要件を無視すること

### 変更時の必須確認
- 既存のSoT仕様との整合性
- API後方互換性の維持
- アクセシビリティ基準の遵守
- パフォーマンス要件の維持