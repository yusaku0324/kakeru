---
version: "3"

tasks:
  login:
    desc: "docker login placeholder"
    cmds: [echo "ðŸ”‘ docker login (stub)"]

  build:
    desc: "docker build image for dev"
    cmds:
      - docker build -t kakeru:dev .

  run-local:
    desc: "run container locally for smoke test"
    cmds:
      - docker run --rm -it -p 8000:8000 kakeru:dev

  web-smoke:
    desc: "build web runtime and smoke-test via curl"
    dir: osakamenesu
    cmds:
      - docker build -f docker/web.Dockerfile --target runner -t osakamenesu-web:smoke .
      - docker run -d --rm --name osakamenesu-web-smoke -p 3000:3000 osakamenesu-web:smoke
      - |
        for i in {1..30}; do
          if curl -fsS http://localhost:3000/ >/dev/null; then
            echo "âœ… web smoke test passed"
            break
          fi
          sleep 2
          if [ "$i" -eq 30 ]; then
            echo "âŒ web smoke test failed" >&2
            docker logs osakamenesu-web-smoke || true
            exit 1
          fi
        done
      - docker stop osakamenesu-web-smoke

  api-smoke:
    desc: "build API runtime and smoke-test /healthz"
    dir: osakamenesu
    cmds:
      - docker build -f docker/api.Dockerfile --target api-runtime -t osakamenesu-api:smoke .
      - docker run -d --rm --name osakamenesu-api-smoke -p 18000:8000 osakamenesu-api:smoke
      - |
        for i in {1..30}; do
          if curl -fsS http://localhost:18000/healthz >/dev/null; then
            echo "âœ… api smoke test passed"
            break
          fi
          sleep 2
          if [ "$i" -eq 30 ]; then
            echo "âŒ api smoke test failed" >&2
            docker logs osakamenesu-api-smoke || true
            exit 1
          fi
        done
      - docker stop osakamenesu-api-smoke

  push:
    desc: "docker push image to GHCR"
    deps: [login]
    cmds:
      - |
        TAG=$(git rev-parse --short=8 HEAD)
        docker tag kakeru:dev ghcr.io/{{.GITHUB_USER}}/kakeru:${TAG}
        docker push ghcr.io/{{.GITHUB_USER}}/kakeru:${TAG}
        echo "ðŸ“¦ pushed ghcr.io/{{.GITHUB_USER}}/kakeru:${TAG}"

  pull-latest:
    desc: "pull latest image from GHCR"
    cmds:
      - docker pull ghcr.io/{{.GITHUB_USER}}/kakeru:latest

  push-tag:
    desc: "push version tag image to GHCR"
    deps: [login]
    cmds:
      - |
        TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        docker tag kakeru:dev ghcr.io/{{.GITHUB_USER}}/kakeru:${TAG}
        docker push ghcr.io/{{.GITHUB_USER}}/kakeru:${TAG}
        echo "ðŸ“¦ pushed ghcr.io/{{.GITHUB_USER}}/kakeru:${TAG}" 
