# yamllint disable rule:line-length
---
version: "3"

tasks:
  _cursor:noop:
    cmds: [echo cursor OK]
  auto:
    desc: "Ensure official 'cursor' CLI is in PATH (macOS)"
    cmds:
      - |
        set -e
        if command -v cursor >/dev/null 2>&1; then
          echo "‚úÖ cursor CLI already present -> $(which cursor)"; exit 0; fi

        # 1) GUI „ÅåÂÖ•„Å£„Å¶„ÅÑ„Çå„Å∞Áõ¥Êé•„Ç∑„Çß„É´„Ç≥„Éû„É≥„Éâ„ÇíÁôªÈå≤
        if [ -e /Applications/Cursor.app ]; then
          echo "‚öôÔ∏è  Trying --install-shell-command flag ‚Ä¶"
          open -a "/Applications/Cursor.app" --args --install-shell-command || true
          sleep 2
        fi

        # 2) AppleScript „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        if ! command -v cursor >/dev/null 2>&1 && [ -e /Applications/Cursor.app ]; then
          echo "‚öôÔ∏è  AppleScript fallback ‚Ä¶"
          osascript \
            -e 'tell application "Cursor" to activate' \
            -e 'delay 1' \
            -e 'tell application "System Events" to keystroke "P" using {command down, shift down}' \
            -e 'delay 0.3' \
            -e 'tell application "System Events" to keystroke "Shell command: Install ""cursor"" command"' \
            -e 'delay 0.3' \
            -e 'tell application "System Events" to key code 36'
          sleep 2
        fi

        # 3) ÊúÄÁµÇÊâãÊÆµ: Homebrew „Åß GUI Êú¨‰Ωì„ÇíÂÖ•„Çå„Å¶ÂÆüË°å
        if ! command -v cursor >/dev/null 2>&1; then
          echo "üîß Installing Cursor GUI via Homebrew‚Ä¶"
          brew install --cask cursor || true
          open -a "/Applications/Cursor.app" --args --install-shell-command || true
          sleep 2
        fi

        if command -v cursor >/dev/null 2>&1; then
          echo "üéâ cursor CLI ready -> $(which cursor)";
        else
          echo "‚ùå Failed to install cursor CLI"; exit 1;
        fi
    silent: false
    status:
      - '[ ! -x "$(command -v cursor)" ]'
